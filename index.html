<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GvP Notenkonferenz â€“ Liveticker</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root {
      --bg: #0b1020;
      --fg: #eaf2ff;
      --color-aktuell: #0ea5e9;   /* hellblau */
      --color-vorb:    #22c55e;   /* grÃ¼n */
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      display: grid;
      grid-template-rows: 1fr 1fr;
      gap: 28px;
      padding: clamp(12px, 3vw, 40px);
      height: 100%;
      box-sizing: border-box;
    }

    .card {
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .aktuell {
      background: linear-gradient(135deg, color-mix(in lab, var(--color-aktuell) 25%, transparent), rgba(255,255,255,.04));
      border: 2px solid color-mix(in lab, var(--color-aktuell) 60%, transparent);
    }

    .vorb {
      background: linear-gradient(135deg, color-mix(in lab, var(--color-vorb) 25%, transparent), rgba(255,255,255,.04));
      border: 2px solid color-mix(in lab, var(--color-vorb) 60%, transparent);
    }

    .label {
      opacity: .85;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: clamp(14px, 2.2vw, 20px);
    }

    /* Verkleinerte Darstellung der Klassen */
    .value {
      margin-top: .25em;
      font-weight: 900;
      line-height: 1.0;
      font-size: clamp(48px, 12vw, 180px);
      word-wrap: break-word;
      letter-spacing: 0.01em;
    }

    /* Zeitstempel unten rechts */
    .footer {
      position: fixed;
      bottom: 10px;
      right: 16px;
      opacity: .5;
      font-size: 12px;
    }

    /* Ton-Schalter: fixiert oben rechts */
    .sound-toggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 10;
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(234,242,255,.25);
      background: rgba(255,255,255,.08);
      color: var(--fg);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 16px; /* Emoji lesbar */
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .btn[aria-pressed="true"] {
      background: rgba(34,197,94,.20);
      border-color: rgba(34,197,94,.55);
    }

    @media (orientation: portrait) {
      .wrap { grid-template-rows: auto auto; }
      .value {
        font-size: clamp(42px, 14vw, 160px);
      }
    }
  </style>
</head>
<body>
  <!-- Ton-Schalter oben rechts -->
  <div class="sound-toggle">
    <button id="soundToggle" class="btn" aria-pressed="false" title="Ton bei Ã„nderungen aktivieren/deaktivieren">
      <span id="bellIcon" aria-hidden="true">ðŸ”•</span>
      <span id="bellText">Ton aus</span>
    </button>
  </div>

  <div class="wrap">
    <section class="card aktuell">
      <div class="label">Laufende Klassenkonferenz</div>
      <div id="aktuell" class="value">â€“</div>
    </section>
    <section class="card vorb">
      <div class="label">In Vorbereitung</div>
      <div id="vorb" class="value">â€“</div>
    </section>
  </div>

  <div class="footer" id="ts"></div>

  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuLVnVCnpc1JPO5eRsUpwOdTjacZ6cgso",
      authDomain: "gvp-notenkonferenz.firebaseapp.com",
      databaseURL: "https://gvp-notenkonferenz-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gvp-notenkonferenz",
      storageBucket: "gvp-notenkonferenz.firebasestorage.app",
      messagingSenderId: "443453428623",
      appId: "1:443453428623:web:3d3640bfe6ed2c38e871fa",
      measurementId: "G-SVZX9DEJNP"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const aktuellEl = document.getElementById('aktuell');
    const vorbEl    = document.getElementById('vorb');
    const tsEl      = document.getElementById('ts');

    const soundToggleBtn = document.getElementById('soundToggle');
    const bellIcon       = document.getElementById('bellIcon');
    const bellText       = document.getElementById('bellText');

    // ===== Audio-Setup =====
    // WÃ¤hle hier den Klangstil: "beep" | "chime" | "pop" | "rise"
    const SOUND_STYLE = "chime";

    // Global-LautstÃ¤rke (lauter als vorher) â€“ bei Bedarf anpassen:
    const MASTER_VOLUME = 0.16; // 0.04 (sehr leise) ... 0.25 (recht prÃ¤sent)

    let audioCtx = null;
    let masterGain = null;
    let compressor = null;
    let soundEnabled = false; // standardmÃ¤ÃŸig aus

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Master Gain
        masterGain = audioCtx.createGain();
        masterGain.gain.value = MASTER_VOLUME;

        // Sanfter Kompressor/Limiter gegen Spitzen
        compressor = audioCtx.createDynamicsCompressor();
        compressor.threshold.value = -18;  // dB
        compressor.knee.value      = 20;
        compressor.ratio.value     = 6;
        compressor.attack.value    = 0.003;
        compressor.release.value   = 0.15;

        // Verkabeln: source -> compressor -> masterGain -> destination
        compressor.connect(masterGain);
        masterGain.connect(audioCtx.destination);
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    // Hilfsfunktion: HÃ¼llkurve anwenden
    function applyADSR(gainNode, {attack=0.01, decay=0.07, sustain=0.6, release=0.12, duration=0.18}) {
      const now = audioCtx.currentTime;
      const end = now + duration;

      gainNode.gain.cancelScheduledValues(now);
      gainNode.gain.setValueAtTime(0.0001, now);
      gainNode.gain.linearRampToValueAtTime(1.0, now + attack);
      gainNode.gain.linearRampToValueAtTime(sustain, now + attack + decay);
      gainNode.gain.setValueAtTime(sustain, end - release);
      gainNode.gain.linearRampToValueAtTime(0.0001, end);
      return { now, end };
    }

    // Einfache Tonerzeugung
    function tone({freq=800, type='sine', duration=0.18, attack=0.01, decay=0.06, sustain=0.6, release=0.10, startFreq=null, endFreq=null}) {
      if (!soundEnabled || !audioCtx) return;
      const osc  = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = type;
      const now = audioCtx.currentTime;

      if (startFreq != null && endFreq != null) {
        // Glide/Portamento
        osc.frequency.setValueAtTime(startFreq, now);
        osc.frequency.exponentialRampToValueAtTime(Math.max(1, endFreq), now + duration);
      } else {
        osc.frequency.value = freq;
      }

      // Soft-Filter gegen schrille HÃ¶hen bei Rechteck/SÃ¤gezahn
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 8000;

      // ADSR
      const env = applyADSR(gain, {attack, decay, sustain, release, duration});

      // Routing: osc -> filter -> compressor -> master
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(compressor);

      osc.start(env.now);
      osc.stop(env.end);
    }

    // Komplexere Presets
    function playSound(style = SOUND_STYLE) {
      if (!soundEnabled || !audioCtx) return;

      switch (style) {
        case "beep": {
          tone({ freq: 800, type: 'sine', duration: 0.18 });
          break;
        }
        case "chime": {
          // Doppelton â€žDing-Dongâ€œ
          tone({ freq: 880, type: 'triangle', duration: 0.12, attack: 0.005, decay: 0.05, sustain: 0.5, release: 0.08 });
          setTimeout(() => {
            tone({ freq: 660, type: 'sine', duration: 0.16, attack: 0.005, decay: 0.07, sustain: 0.55, release: 0.11 });
          }, 95);
          break;
        }
        case "pop": {
          // kurzer perkussiver Pop (rauscharmer Klick)
          tone({ freq: 500, type: 'square', duration: 0.07, attack: 0.002, decay: 0.04, sustain: 0.25, release: 0.04 });
          break;
        }
        case "rise": {
          // schneller aufsteigender Ping (Glide)
          tone({ startFreq: 520, endFreq: 1040, type: 'sine', duration: 0.22, attack: 0.006, decay: 0.06, sustain: 0.5, release: 0.08 });
          break;
        }
        default: {
          tone({ freq: 800, type: 'sine', duration: 0.18 });
        }
      }
    }

    function updateBellUI() {
      soundToggleBtn.setAttribute('aria-pressed', soundEnabled ? 'true' : 'false');
      bellIcon.textContent = soundEnabled ? 'ðŸ””' : 'ðŸ”•';
      bellText.textContent = soundEnabled ? 'Ton an' : 'Ton aus';
    }

    soundToggleBtn.addEventListener('click', () => {
      if (!soundEnabled) {
        initAudio();
        soundEnabled = true;
        updateBellUI();
        // kurzer BestÃ¤tigungston (unabhÃ¤ngig vom Preset)
        tone({ freq: 520, type: 'triangle', duration: 0.12, attack: 0.004, decay: 0.05, sustain: 0.5, release: 0.06 });
      } else {
        soundEnabled = false;
        updateBellUI();
      }
    });

    // ===== Ã„nderungsdetektion & Anzeige =====
    let prev = { aktuell: null, vorbereitung: null };

    onValue(ref(db, 'anzeige'), (snap) => {
      const v = snap.val() || {};
      const neuAktuell = v.aktuell || 'â€“';
      const neuVorb    = v.vorbereitung || 'â€“';

      const changed =
        (prev.aktuell !== null && prev.aktuell !== neuAktuell) ||
        (prev.vorbereitung !== null && prev.vorbereitung !== neuVorb);

      aktuellEl.textContent = neuAktuell;
      vorbEl.textContent    = neuVorb;

      document.documentElement.style.setProperty('--color-aktuell', v.colorAktuell || '#0ea5e9');
      document.documentElement.style.setProperty('--color-vorb',    v.colorVorb    || '#22c55e');

      const dt = v.updatedAt ? new Date(v.updatedAt) : null;
      tsEl.textContent = dt ? `Stand: ${dt.toLocaleString('de-AT')}` : '';

      // Ein einziger Ton pro Update (da beide synchron sind)
      if (changed) playSound();
      prev = { aktuell: neuAktuell, vorbereitung: neuVorb };
    });

    // initiale UI (inaktiv)
    updateBellUI();
  </script>
</body>
</html>
